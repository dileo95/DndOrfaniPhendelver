<div class="header">
  <div class="header-left"></div>
  <div style="position: absolute; left: 0px; top: 0px; width: 100%; height: 40px; background: transparent">
    <h1 style="line-height: 40px; text-align: center; margin: 0; font-size: 30px;">
      âš”ï¸ Combat Arena
    </h1>
  </div>
  <div class="header-right"></div>
  <button class="back" style="position: absolute;" (click)="goBack()">
    <img src="./assets/img/back-arrow.png" style="width: 20px; margin-top: 10px;" alt="Back" />
  </button>
</div>

<div class="combat-container" style="padding-top: 60px;">
  
  <!-- ========== SETUP PHASE ========== -->
  @if (gamePhase() === 'setup') {
    <div class="setup-phase">
      <h2>ğŸ¯ Seleziona il tuo avversario</h2>
      
      <div class="enemy-grid">
        @for (enemy of enemies; track enemy.id) {
          <div 
            class="enemy-card" 
            [class.selected]="selectedEnemy()?.id === enemy.id"
            [style.border-left]="'4px solid #' + enemy.color.toString(16).padStart(6, '0')"
            (click)="selectEnemy(enemy)">
            <div class="enemy-header">
              <span class="enemy-icon" [style.background]="'#' + enemy.color.toString(16).padStart(6, '0')">
                {{ getEnemyIcon(enemy) }}
              </span>
              <span class="enemy-name">{{ enemy.name }}</span>
              <span class="enemy-cr">CR {{ enemy.cr }}</span>
            </div>
            <div class="enemy-stats">
              <span>â¤ï¸ {{ enemy.hp }} HP</span>
              <span>ğŸ›¡ï¸ CA {{ enemy.ac }}</span>
              <span>âš”ï¸ +{{ enemy.attackBonus }}</span>
            </div>
            <div class="enemy-damage">{{ enemy.damage }} {{ enemy.damageType }}</div>
            @if (enemy.abilities) {
              <div class="enemy-abilities">
                @for (ability of enemy.abilities; track ability) {
                  <span class="ability-tag">{{ ability }}</span>
                }
              </div>
            }
            <p class="enemy-desc">{{ enemy.description }}</p>
            <div class="enemy-xp">ğŸ† {{ enemy.xp }} XP</div>
          </div>
        }
      </div>
      
      <!-- Player Status Warning -->
      @if (playerHP() <= 0) {
        <div class="warning-banner">
          <span class="warning-icon">ğŸ’€</span>
          <span>Sei a 0 punti ferita! Devi riposarti prima di poter combattere.</span>
        </div>
      }
      
      @if (!sheetExists()) {
        <div class="warning-banner info">
          <span class="warning-icon">ğŸ“‹</span>
          <span>Scheda personaggio non trovata. Vai alla scheda personaggio per crearla.</span>
        </div>
      }
      
      @if (selectedEnemy()) {
        <button 
          class="btn-start" 
          [class.disabled]="!canStartCombat().canStart"
          [disabled]="!canStartCombat().canStart"
          (click)="startCombat()">
          @if (canStartCombat().canStart) {
            âš”ï¸ Inizia Combattimento vs {{ selectedEnemy()!.name }}
          } @else {
            ğŸš« {{ canStartCombat().reason }}
          }
        </button>
      }
    </div>
  }
  
  <!-- ========== COMBAT PHASE ========== -->
  @if (gamePhase() === 'combat' || gamePhase() === 'victory' || gamePhase() === 'defeat') {
    <div class="combat-phase">
      <!-- Game Canvas -->
      <div class="game-area">
        <div #gameContainer class="game-container"></div>
        
        <!-- HP Bars Overlay -->
        <div class="hp-overlay">
          <div class="hp-section player-hp">
            <span class="hp-name">{{ getPlayerName() }}</span>
            <div class="hp-bar-container">
              <div class="hp-bar" [style.width.%]="playerHPPercent()" 
                   [class.low]="playerHPPercent() < 25"
                   [class.medium]="playerHPPercent() >= 25 && playerHPPercent() < 50"></div>
            </div>
            <span class="hp-text">{{ playerHP() }} / {{ playerMaxHP() }}</span>
          </div>
          
          <div class="round-indicator">Round {{ currentRound() }}</div>
          
          <div class="hp-section enemy-hp">
            <span class="hp-name">{{ selectedEnemy()!.name }}</span>
            <div class="hp-bar-container">
              <div class="hp-bar enemy" [style.width.%]="enemyHPPercent()"></div>
            </div>
            <span class="hp-text">{{ enemyHP() }} / {{ enemyMaxHP() }}</span>
          </div>
        </div>
      </div>
      
      <!-- Combat Controls -->
      @if (gamePhase() === 'combat') {
        <div class="combat-controls" [class.disabled]="!isPlayerTurn()">
          <div class="turn-indicator" [class.player-turn]="isPlayerTurn()">
            {{ isPlayerTurn() ? 'ğŸ® Il tuo turno!' : 'ğŸ‘¹ Turno nemico...' }}
          </div>
          
          <!-- Weapons -->
          <div class="action-section">
            <h3>âš”ï¸ Armi</h3>
            <div class="action-buttons">
              @if (sheet()?.weapons) {
                @for (weapon of sheet()!.weapons; track weapon.name) {
                  <button class="action-btn weapon" (click)="attackWithWeapon(weapon)" [disabled]="!isPlayerTurn()">
                    <span class="action-name">{{ weapon.name }}</span>
                    <span class="action-detail">+{{ weapon.attackBonus }} | {{ weapon.damage }}</span>
                  </button>
                }
              }
            </div>
          </div>
          
          <!-- Spells -->
          @if (availableSpells().length > 0) {
            <div class="action-section">
              <h3>âœ¨ Incantesimi</h3>
              <div class="action-buttons spells">
                @for (spell of availableSpells(); track spell.name) {
                  <button class="action-btn spell" (click)="castSpell(spell)" [disabled]="!isPlayerTurn()">
                    <span class="action-name">{{ spell.name }}</span>
                    <span class="action-detail">Lvl {{ spell.level }} | {{ spell.school }}</span>
                  </button>
                }
              </div>
            </div>
          }
          
          <!-- Other Actions -->
          <div class="action-section">
            <h3>ğŸ¯ Azioni</h3>
            <div class="action-buttons">
              <button class="action-btn defend" (click)="defend()" [disabled]="!isPlayerTurn()">
                <span class="action-name">ğŸ›¡ï¸ Difesa</span>
                <span class="action-detail">+2 CA fino al prossimo turno</span>
              </button>
              <button class="action-btn potion" (click)="usePotion()" [disabled]="!isPlayerTurn()">
                <span class="action-name">ğŸ§ª Pozione</span>
                <span class="action-detail">Cura 2d4+2 HP</span>
              </button>
            </div>
          </div>
        </div>
      }
      
      <!-- Victory/Defeat -->
      @if (gamePhase() === 'victory') {
        <div class="result-screen victory">
          <h2>ğŸ‰ VITTORIA!</h2>
          <p>Hai sconfitto {{ selectedEnemy()!.name }}!</p>
          <p class="xp-gain">+{{ selectedEnemy()!.xp }} XP</p>
          <button class="btn-restart" (click)="resetCombat()">ğŸ”„ Nuovo Combattimento</button>
        </div>
      }
      
      @if (gamePhase() === 'defeat') {
        <div class="result-screen defeat">
          <h2>ğŸ’€ SCONFITTA</h2>
          <p>{{ getPlayerName() }} Ã¨ caduto in battaglia...</p>
          <button class="btn-restart" (click)="resetCombat()">ğŸ”„ Riprova</button>
        </div>
      }
      
      <!-- Combat Log -->
      <div class="combat-log">
        <h3>ğŸ“œ Log Combattimento</h3>
        <div class="log-entries">
          @for (entry of combatLog(); track $index) {
            <div class="log-entry">{{ entry }}</div>
          }
        </div>
      </div>
    </div>
  }
</div>
