<div class="header">
  <div class="header-left"></div>
  <div style="position: absolute; left: 0px; top: 0px; width: 100%; height: 40px; background: transparent">
    <h1 style="line-height: 40px; text-align: center; margin: 0; font-size: 30px;">
      üìù Appunti di {{ character() | titlecase }}
    </h1>
  </div>
  <div class="header-right"></div>
  <button class="back" style="position: absolute;" (click)="goBack()">
    <img src="./assets/img/back-arrow.png" style="width: 20px; margin-top: 10px;" alt="Back" />
  </button>
</div>

<div class="notes-container" [class.mobile]="isMobile()" style="padding-top: 60px;">
  <header class="notes-header">
    <h1>üìù Appunti di {{ character() | titlecase }}</h1>
    <!-- Nascosto su mobile, usa FAB -->
    @if (!isMobile()) {
      <button class="btn-add-note" (click)="openNewNoteForm()">
        ‚ûï Nuova Nota
      </button>
    }
  </header>

  <!-- Barra di Ricerca e Filtri -->
  <div class="search-filters-section">
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        [(ngModel)]="searchQuery"
        placeholder="Cerca nelle note..."
        class="search-input">
      @if (searchQuery()) {
        <button class="clear-search" (click)="searchQuery.set('')">‚úï</button>
      }
    </div>

    <div class="filters-row">
      <!-- Toggle View Mode -->
      <div class="view-toggle">
        <button 
          class="view-btn" 
          [class.active]="viewMode() === 'grid'"
          (click)="viewMode.set('grid')"
          title="Vista griglia">
          ‚äû
        </button>
        <button 
          class="view-btn" 
          [class.active]="viewMode() === 'list'"
          (click)="viewMode.set('list')"
          title="Vista lista">
          ‚ò∞
        </button>
      </div>

      <!-- Ordinamento -->
      <div class="sort-select">
        <label>Ordina:</label>
        <select [(ngModel)]="sortBy">
          <option value="newest">Pi√π recenti</option>
          <option value="oldest">Pi√π vecchi</option>
          <option value="alphabetical">Alfabetico</option>
        </select>
      </div>

      <!-- Reset filtri -->
      @if (hasActiveFilters()) {
        <button class="btn-clear-filters" (click)="clearFilters()">
          üîÑ Reset filtri
        </button>
      }
    </div>

    <!-- Filtro Tags -->
    @if (allTags().length > 0) {
      <div class="tags-filter">
        <span class="tags-label">Filtra per tag:</span>
        <div class="tags-list">
          @for (tag of allTags(); track tag) {
            <button 
              class="filter-tag"
              [class.active]="isTagSelected(tag)"
              (click)="toggleTag(tag)">
              {{ tag }}
            </button>
          }
        </div>
      </div>
    }

    <!-- Filtro Colori -->
    <div class="colors-filter">
      <span class="colors-label">Filtra per colore:</span>
      <div class="colors-list">
        @for (color of colors; track color.id) {
          <button 
            class="filter-color"
            [class.active]="selectedColor() === color.id"
            [style.background]="color.hex"
            [title]="color.label"
            (click)="selectedColor.set(selectedColor() === color.id ? '' : color.id)">
          </button>
        }
      </div>
    </div>

    <!-- Risultati + Expand/Collapse All -->
    <div class="results-row">
      <div class="results-info">
        @if (searchQuery() || selectedTags().length > 0 || selectedColor()) {
          <span>{{ filteredNotes().length }} risultat{{ filteredNotes().length === 1 ? 'o' : 'i' }} trovat{{ filteredNotes().length === 1 ? 'o' : 'i' }}</span>
        } @else {
          <span>{{ notes().length }} not{{ notes().length === 1 ? 'a' : 'e' }} totali</span>
        }
      </div>
      
      @if (filteredNotes().length > 0) {
        <div class="expand-collapse-buttons">
          <button class="btn-expand-all" (click)="expandAll()" title="Espandi tutte">
            üìñ Espandi
          </button>
          <button class="btn-collapse-all" (click)="collapseAll()" title="Comprimi tutte">
            üìï Comprimi
          </button>
        </div>
      }
    </div>
  </div>

  <!-- Form Nuova/Modifica Nota -->
  @if (showForm()) {
    <div class="note-form-overlay" (click)="closeForm()">
      <div class="note-form" (click)="$event.stopPropagation()">
        <h2>{{ editingNote() ? 'Modifica Nota' : 'Nuova Nota' }}</h2>
        
        <div class="form-group">
          <label for="note-title">Titolo</label>
          <input
            id="note-title"
            type="text"
            [(ngModel)]="noteTitle"
            placeholder="Es: Indizi sulla False Hydra"
            class="form-input">
        </div>

        <div class="form-group">
          <div class="content-header">
            <label for="note-content">Contenuto</label>
            <button 
              type="button" 
              class="btn-preview-toggle"
              (click)="showPreview.set(!showPreview())">
              {{ showPreview() ? '‚úèÔ∏è Modifica' : 'üëÅÔ∏è Preview' }}
            </button>
          </div>
          
          <!-- Markdown Toolbar -->
          @if (!showPreview()) {
            <div class="markdown-toolbar">
              <button type="button" (click)="insertBold()" title="Grassetto (Ctrl+B)">
                <strong>B</strong>
              </button>
              <button type="button" (click)="insertItalic()" title="Corsivo (Ctrl+I)">
                <em>I</em>
              </button>
              <button type="button" (click)="insertHeading()" title="Titolo">
                H
              </button>
              <span class="toolbar-divider"></span>
              <button type="button" (click)="insertList()" title="Lista puntata">
                ‚Ä¢
              </button>
              <button type="button" (click)="insertNumberedList()" title="Lista numerata">
                1.
              </button>
              <button type="button" (click)="insertQuote()" title="Citazione">
                ‚ùù
              </button>
              <span class="toolbar-divider"></span>
              <button type="button" (click)="insertLink()" title="Link">
                üîó
              </button>
              <button type="button" (click)="insertCode()" title="Codice">
                &lt;/&gt;
              </button>
              <button type="button" (click)="insertHr()" title="Linea orizzontale">
                ‚Äï
              </button>
            </div>
          }

          @if (showPreview()) {
            <!-- Preview Mode -->
            <div class="markdown-preview" [innerHTML]="parseMarkdown(noteContent())"></div>
          } @else {
            <!-- Edit Mode -->
            <textarea
              #contentTextarea
              id="note-content"
              [(ngModel)]="noteContent"
              placeholder="Scrivi qui i tuoi appunti...

Supporta Markdown:
**grassetto**, *corsivo*, ~~barrato~~
## Titoli
- Liste puntate
1. Liste numerate
> Citazioni
[link](url)
`codice`"
              rows="10"
              class="form-textarea"></textarea>
          }
        </div>

        <div class="form-group">
          <label for="note-tags">Tags (separati da virgola)</label>
          <input
            id="note-tags"
            type="text"
            [(ngModel)]="noteTags"
            placeholder="Es: mostro, indagine, png"
            class="form-input">
        </div>

        <div class="form-group">
          <label>Colore</label>
          <div class="color-picker">
            @for (color of colors; track color.id) {
              <button 
                type="button"
                class="color-option"
                [class.selected]="noteColor() === color.id"
                [style.background]="color.hex"
                [title]="color.label"
                (click)="noteColor.set(color.id)">
                @if (noteColor() === color.id) {
                  <span class="checkmark">‚úì</span>
                }
              </button>
            }
          </div>
        </div>

        <!-- Link Entit√† Story-Map -->
        <div class="form-group">
          <label>üîó Collega a Personaggi/Luoghi</label>
          
          <!-- Entit√† gi√† collegate -->
          @if (noteLinkedEntities().length > 0) {
            <div class="linked-entities-list">
              @for (entityId of noteLinkedEntities(); track entityId) {
                @if (getEntityById(entityId); as entity) {
                  <div class="linked-entity-chip" [style.borderColor]="getEntityColor(entity.type)">
                    <span class="entity-icon">{{ getEntityIcon(entity.type) }}</span>
                    <span class="entity-name">{{ entity.name }}</span>
                    <button 
                      type="button" 
                      class="remove-entity" 
                      (click)="removeLinkedEntity(entityId)"
                      title="Rimuovi">‚úï</button>
                  </div>
                }
              }
            </div>
          }
          
          <!-- Selettore entit√† -->
          <div class="entity-selector">
            <div class="entity-search-wrapper">
              <input 
                type="text"
                [(ngModel)]="entitySearchQuery"
                placeholder="Cerca personaggio, luogo, organizzazione..."
                class="entity-search-input"
                (focus)="showEntitySelector.set(true)">
              <button 
                type="button"
                class="btn-toggle-selector"
                (click)="toggleEntitySelector()">
                {{ showEntitySelector() ? '‚ñ≤' : '‚ñº' }}
              </button>
            </div>
            
            @if (showEntitySelector() && filteredEntities().length > 0) {
              <div class="entity-dropdown">
                @for (entity of filteredEntities(); track entity.id) {
                  <button 
                    type="button"
                    class="entity-option"
                    (click)="addLinkedEntity(entity.id)">
                    <span class="entity-icon" [style.color]="getEntityColor(entity.type)">
                      {{ getEntityIcon(entity.type) }}
                    </span>
                    <div class="entity-info">
                      <span class="entity-name">{{ entity.name }}</span>
                      <span class="entity-desc">{{ entity.description | slice:0:50 }}...</span>
                    </div>
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <div class="form-actions">
          <button class="btn-cancel" (click)="closeForm()">Annulla</button>
          <button class="btn-save" (click)="saveNote()">
            {{ editingNote() ? 'Salva Modifiche' : 'Crea Nota' }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Lista Note -->
  <div class="notes-grid" [class.list-view]="viewMode() === 'list'">
    @if (filteredNotes().length === 0) {
      <div class="empty-state">
        @if (searchQuery() || selectedTags().length > 0) {
          <p>üîç Nessuna nota trovata con questi filtri</p>
          <button class="btn-clear-filters" (click)="clearFilters()">Rimuovi filtri</button>
        } @else {
          <p>üìñ Nessuna nota ancora. Inizia a scrivere i tuoi appunti!</p>
        }
      </div>
    }

    @for (note of filteredNotes(); track note.id) {
      <div 
        class="note-card" 
        [class.expanded]="isExpanded(note.id!)"
        [class.swiped]="isNoteSwiped(note.id!)"
        [class.list-item]="viewMode() === 'list'"
        [style.borderColor]="getColorHex(note.color || 'gold')"
        (touchstart)="onTouchStart($event, note.id!)"
        (touchend)="onTouchEnd($event, note)">
        
        <!-- Swipe Actions (revealed on swipe left) -->
        <div class="swipe-actions" [style.background]="getColorHex(note.color || 'gold')">
          <button class="swipe-btn edit" (click)="quickEdit(note)" title="Modifica">
            ‚úèÔ∏è
          </button>
          <button class="swipe-btn pin" (click)="quickPin(note)" title="Pin">
            {{ note.pinned ? '‚≠ê' : '‚òÜ' }}
          </button>
          <button class="swipe-btn delete" (click)="quickDelete(note)" title="Elimina">
            üóëÔ∏è
          </button>
        </div>
        
        <!-- Card Content -->
        <div class="note-card-content">
          <!-- Pin indicator -->
          @if (note.pinned) {
            <div class="pin-badge">üìå</div>
          }
          
          <!-- Color stripe -->
          <div class="color-stripe" [style.background]="getColorHex(note.color || 'gold')"></div>
          
          <div class="note-card-header">
            <h3>{{ note.title }}</h3>
            <!-- Azioni visibili solo su desktop o in list view -->
            @if (!isMobile() || viewMode() === 'list') {
              <div class="note-actions">
                <button 
                  class="btn-icon btn-pin" 
                  [class.pinned]="note.pinned"
                  (click)="togglePin(note)" 
                  [title]="note.pinned ? 'Rimuovi pin' : 'Fissa in alto'">
                  {{ note.pinned ? '‚≠ê' : '‚òÜ' }}
                </button>
                <button class="btn-icon" (click)="openEditForm(note)" title="Modifica">
                  ‚úèÔ∏è
                </button>
                <button class="btn-icon" (click)="deleteNote(note)" title="Elimina">
                  üóëÔ∏è
                </button>
              </div>
            }
          </div>

          <!-- Contenuto con espandi/comprimi -->
          <div class="note-content-wrapper" [class.truncated]="!isExpanded(note.id!) && shouldTruncate(note.content)">
            @if (isExpanded(note.id!) || !shouldTruncate(note.content)) {
              <div class="note-content markdown-rendered" [innerHTML]="parseMarkdown(note.content)"></div>
            } @else {
              <div class="note-content markdown-rendered" [innerHTML]="parseMarkdown(getPreviewContent(note.content))"></div>
            }
          </div>

          <!-- Pulsante espandi/comprimi -->
          @if (shouldTruncate(note.content)) {
            <button 
              class="btn-expand-toggle" 
              (click)="toggleExpand(note.id!)"
              [style.color]="getColorHex(note.color || 'gold')">
              @if (isExpanded(note.id!)) {
                <span>‚ñ≤ Mostra meno</span>
              } @else {
                <span>‚ñº Leggi tutto</span>
              }
            </button>
          }

          @if (note.tags && note.tags.length > 0) {
            <div class="note-tags">
              @for (tag of note.tags; track tag) {
                <span class="tag" [style.borderColor]="getColorHex(note.color || 'gold')">{{ tag }}</span>
              }
            </div>
          }

          <!-- Entit√† Collegate -->
          @if (note.linkedEntities && note.linkedEntities.length > 0) {
            <div class="note-linked-entities">
              @for (entityId of note.linkedEntities; track entityId) {
                @if (getEntityById(entityId); as entity) {
                  <button 
                    class="linked-entity-badge"
                    [style.borderColor]="getEntityColor(entity.type)"
                    [style.background]="getEntityColor(entity.type) + '22'"
                    (click)="showEntityPreview(entity)"
                    title="Clicca per dettagli">
                    <span class="badge-icon">{{ getEntityIcon(entity.type) }}</span>
                    <span class="badge-name">{{ entity.name }}</span>
                  </button>
                }
              }
            </div>
          }

          <div class="note-footer">
            <small>
              Aggiornato il {{ formatDate(note.updatedAt) }}
            </small>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Entity Preview Modal -->
  @if (selectedEntityPreview()) {
    <div class="entity-preview-overlay" (click)="closeEntityPreview()">
      <div class="entity-preview-modal" (click)="$event.stopPropagation()">
        @if (selectedEntityPreview(); as entity) {
          <div class="entity-preview-header" [style.borderColor]="getEntityColor(entity.type)">
            <span class="preview-icon" [style.color]="getEntityColor(entity.type)">
              {{ getEntityIcon(entity.type) }}
            </span>
            <h3>{{ entity.name }}</h3>
            <button class="btn-close-preview" (click)="closeEntityPreview()">‚úï</button>
          </div>
          <div class="entity-preview-body">
            @if (entity.image) {
              <img [src]="entity.image" [alt]="entity.name" class="entity-preview-image">
            }
            <p class="entity-description">{{ entity.description }}</p>
            <div class="entity-meta">
              <span class="entity-type-badge" [style.background]="getEntityColor(entity.type)">
                {{ entity.type === 'character' ? 'Personaggio' : 
                   entity.type === 'location' ? 'Luogo' : 
                   entity.type === 'organization' ? 'Organizzazione' : 'Evento' }}
              </span>
              <span class="entity-chapter">
                {{ entity.chapter === 'previous' ? 'üìñ Avventure Passate' : 'üìú Storia Attuale' }}
              </span>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- FAB Button per mobile - aggiunge nuova nota -->
  @if (isMobile() && !showForm()) {
    <button class="fab" (click)="openNewNoteForm()" title="Nuova nota">
      ‚ûï
    </button>
  }
</div>
